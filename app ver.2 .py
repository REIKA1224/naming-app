# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import streamlit as st          # Webã‚¢ãƒ—ãƒªã‚’ä½œã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
import pandas as pd             # è¡¨å½¢å¼ãƒ‡ãƒ¼ã‚¿ï¼ˆDataFrameï¼‰ã‚’æ‰±ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚CSVä¿å­˜ã«ä½¿ç”¨
from datetime import datetime   # æ—¥ä»˜ãƒ»æ™‚åˆ»ã‚’æ‰±ã†æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
from openai import OpenAI       # OpenAIã®APIã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¹
import plotly.graph_objects as go  # ã‚°ãƒ©ãƒ•ã‚’æããŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
import re                          # æ–‡å­—ã®ä¸­ã‹ã‚‰æ•°å­—ã‚’æŠœãå‡ºã™ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

# ãã®ä¸‹ã«ã‚¿ã‚¤ãƒˆãƒ«
st.title("AI å‘½åæ”¯æ´ãƒ„ãƒ¼ãƒ«")


# OpenAIã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–
client = OpenAI()

# ------------------------------
# å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
# -----------------------------    
# ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§ã¯ãªãã€ãƒ¡ã‚¤ãƒ³ç”»é¢ä¸Šéƒ¨ã«æŠ˜ã‚ŠãŸãŸã¿ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨ã—ã¦é…ç½®
with st.expander("å…¥åŠ›æ¡ä»¶ã‚’é–‹ã", expanded=True):
    
    # --------------------------------------------------
    # 1. UIæ”¹å–„ & è‹—å­—ãƒ»è©³ç´°æ¡ä»¶ã®å…¥åŠ›
    # --------------------------------------------------
    st.markdown("### ğŸ“‹ å‘½åã®æ¡ä»¶")

    # ã‚¸ãƒ£ãƒ³ãƒ«é¸æŠï¼ˆæ¨ªä¸¦ã³ã«ã™ã‚‹ï¼‰
    target_type = st.radio("å‘½åã™ã‚‹å¯¾è±¡", ["äººé–“", "ãƒšãƒƒãƒˆ", "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼"], horizontal=True)

    # è‹—å­—ã¨æ€§åˆ¥ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹
    col1, col2 = st.columns(2)
    with col1:
        surname = st.text_input("è‹—å­—ï¼ˆçœç•¥å¯ï¼‰", placeholder="ä¾‹ï¼šä½è—¤")
    with col2:
        gender = st.selectbox("æ€§åˆ¥", ["æŒ‡å®šãªã—", "ç”·", "å¥³"])

    # ä½¿ã„ãŸã„æ¼¢å­—ãƒ»é¿ã‘ãŸã„æ¼¢å­—ï¼ˆæ¨ªä¸¦ã³ã§è¦‹ã‚„ã™ãï¼‰
    col3, col4 = st.columns(2)
    with col3:
        use_kanji = st.text_input("ä½¿ã„ãŸã„æ¼¢å­—", placeholder="ä¾‹ï¼šç¿”ã€æ„›")
    with col4:
        avoid_kanji = st.text_input("é¿ã‘ãŸã„æ¼¢å­—", placeholder="ä¾‹ï¼šæ‚ªã€æ­»")

    # é¡˜ã„ã®å…¥åŠ›
    wish = st.text_area("ã©ã‚“ãªé¡˜ã„ã‚’è¾¼ã‚ã¾ã™ã‹ï¼Ÿ", placeholder="ä¾‹ï¼šå„ªã—ãã¦èŠ¯ã®å¼·ã„å­ã«è‚²ã£ã¦ã»ã—ã„")

    # ç”Ÿæˆãƒœã‚¿ãƒ³
    submit_btn = st.button("âœ¨ AIã«åå‰ã‚’è€ƒãˆã¦ã‚‚ã‚‰ã†", use_container_width=True, type="primary")
# --------------------------------------------------
# 2. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆAIã¸ã®æŒ‡ç¤ºï¼‰ã®å¤‰æ›´
# --------------------------------------------------
# --------------------------------------------------
# 2. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆAIã¸ã®æŒ‡ç¤ºï¼‰ã®å®Ÿè¡Œã¨è¡¨ç¤º
# --------------------------------------------------
if submit_btn:
    if not wish:
        st.warning("ã€Œé¡˜ã„ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼")
    else:
        surname_text = f"è‹—å­—ã€Œ{surname}ã€" if surname else "è‹—å­—ãªã—"

        # -------------------------------------------------------
        # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼š5é …ç›®ã§æ¡ç‚¹ã•ã›ã‚‹
        # -------------------------------------------------------
        prompt = f"""
        ã‚ãªãŸã¯è¾›å£ã‹ã¤çš„ç¢ºãªãƒ—ãƒ­ã®å‘½åã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚
        ä»¥ä¸‹ã®æ¡ä»¶ã«åŸºã¥ã„ã¦ã€åå‰ã‚’3ã¤ææ¡ˆã—ã¦ãã ã•ã„ã€‚
        
        ã€é‡è¦ï¼šè©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ ã€‘
        ææ¡ˆã™ã‚‹åå‰ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®5é …ç›®ã§å³å¯†ã«æ¡ç‚¹ï¼ˆå„100ç‚¹æº€ç‚¹ï¼‰ã—ã¦ãã ã•ã„ã€‚
        å…¨ã¦ã‚’é«˜å¾—ç‚¹ã«ã›ãšã€å³å¯†ãªåŸºæº–ã§ãƒ•ãƒ©ãƒƒãƒˆã«é …ç›®ã®ç‰¹å¾´ã«åˆã‚ã›ã¦ãƒ¡ãƒªãƒãƒªã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚

        1. ã€éŸ¿ãã€‘å‘¼ã‚“ã æ™‚ã®ãƒªã‚ºãƒ ã€è‹—å­—ã¨ã®èªå‘‚
        2. ã€å­—å½¢ã€‘æ¼¢å­—ã®ãƒãƒ©ãƒ³ã‚¹ã€è¦‹ãŸç›®ã®ç¾ã—ã•
        3. ã€ç‹¬å‰µã€‘ãƒ¦ãƒ‹ãƒ¼ã‚¯ã•ã€è¢«ã‚Šã«ãã•
        4. ã€å¯èª­ã€‘èª°ã§ã‚‚èª­ã‚ã‚‹ã‹ï¼ˆç‹¬å‰µæ€§ãŒé«˜ã„ã¨ä¸‹ãŒã‚Šã‚„ã™ã„ï¼‰
        5. ã€é¡˜ã„ã€‘ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¡˜ã„ã¨åˆè‡´ã—ã¦ã„ã‚‹ã‹

        ã€é‡è¦ã€‘
        å‡ºåŠ›æ™‚ã¯ã€Œ**ã€ãªã©ã®å¤ªå­—è¨˜å·ã‚„è¦‹å‡ºã—è¨˜å·ï¼ˆ###ï¼‰ã¯ä¸€åˆ‡ä½¿ã‚ãšã€
        æ™®é€šã®ãƒ†ã‚­ã‚¹ãƒˆã ã‘ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

        ã€æ¡ä»¶ã€‘
        ãƒ»å¯¾è±¡ï¼š{target_type}
        ãƒ»æ€§åˆ¥ï¼š{gender}
        ãƒ»ä½¿ã„ãŸã„æ¼¢å­—ï¼š{use_kanji}
        ãƒ»é¿ã‘ãŸã„æ¼¢å­—ï¼š{avoid_kanji}
        ãƒ»é¡˜ã„ï¼š{wish}
        
        ã€å‡ºåŠ›å½¢å¼ã€‘
        å¿…ãšä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚

        ---
        åå‰ï¼šã€‡ã€‡ï¼ˆãƒ¨ãƒŸï¼‰
        [å†…è¨³]
        ãƒ»éŸ¿ãï¼š80ç‚¹
        ãƒ»å­—å½¢ï¼š90ç‚¹
        ãƒ»ç‹¬å‰µï¼š95ç‚¹
        ãƒ»å¯èª­ï¼š60ç‚¹
        ãƒ»é¡˜ã„ï¼š100ç‚¹
        
        ç†ç”±ï¼šã€œã€œã€œ
        ---
        """

        with st.spinner("ğŸ’ 5ã¤ã®è¦³ç‚¹ã‹ã‚‰å³å¯†ã«åˆ†æä¸­..."):
            try:
                response = client.chat.completions.create(
                    model="gpt-4o-mini",
                    messages=[{"role": "user", "content": prompt}]
                )
                
                response_content = response.choices[0].message.content
                st.success("åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸï¼")

                # çµæœè¡¨ç¤ºå‡¦ç†
                sections = response_content.split('---')

                for section in sections:
                    if "åå‰ï¼š" not in section:
                        continue
                    
                    # ------------------------------------------------
                    # 1. æ­£è¦è¡¨ç¾ã§5ã¤ã®ç‚¹æ•°ã‚’æŠœãå‡ºã™
                    # ------------------------------------------------
                    name_match = re.search(r"åå‰ï¼š(.*?)\n", section)
                    
                    # 5ã¤ã®é …ç›®ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°0ç‚¹ï¼‰
                    s_hibiki = int(re.search(r"éŸ¿ãï¼š(\d+)ç‚¹", section).group(1)) if re.search(r"éŸ¿ãï¼š(\d+)ç‚¹", section) else 50
                    s_jikei  = int(re.search(r"å­—å½¢ï¼š(\d+)ç‚¹", section).group(1)) if re.search(r"å­—å½¢ï¼š(\d+)ç‚¹", section) else 50
                    s_doku   = int(re.search(r"ç‹¬å‰µï¼š(\d+)ç‚¹", section).group(1)) if re.search(r"ç‹¬å‰µï¼š(\d+)ç‚¹", section) else 50
                    s_kadoku = int(re.search(r"å¯èª­ï¼š(\d+)ç‚¹", section).group(1)) if re.search(r"å¯èª­ï¼š(\d+)ç‚¹", section) else 50
                    s_negai  = int(re.search(r"é¡˜ã„ï¼š(\d+)ç‚¹", section).group(1)) if re.search(r"é¡˜ã„ï¼š(\d+)ç‚¹", section) else 50

                    if name_match:
                        name = name_match.group(1).strip()
                        
                        # ------------------------------------------------
                        # 2. äº”è§’å½¢ã®ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ
                        # ------------------------------------------------
                        # é …ç›®å
                        categories = ['éŸ¿ã', 'å­—å½¢', 'ç‹¬å‰µ', 'å¯èª­', 'é¡˜ã„']
                        # å€¤
                        values = [s_hibiki, s_jikei, s_doku, s_kadoku, s_negai]
                        
                        # é–‰ã˜ã‚‹ãŸã‚ã«æœ€åˆã®å€¤ã‚’æœ€å¾Œã«è¿½åŠ 
                        values += [values[0]]
                        categories += [categories[0]]

                        fig = go.Figure(
                            data=[
                                go.Scatterpolar(
                                    r=values,
                                    theta=categories,
                                    fill='toself',
                                    name=name,
                                    line_color='#00CC96' # ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã‚°ãƒªãƒ¼ãƒ³ï¼ˆä»Šé¢¨ã®è‰²ï¼‰
                                )
                            ]
                        )

                        fig.update_layout(
                            polar=dict(
                                radialaxis=dict(visible=True, range=[0, 100])
                            ),
                            showlegend=False,
                            height=300,
                            margin=dict(t=30, b=30, l=40, r=40)
                        )

                        # ------------------------------------------------
                        # 3. è¡¨ç¤º
                        # ------------------------------------------------
                        with st.container(border=True):
                            col_text, col_graph = st.columns([1, 1]) # åŠã€…ã«ã™ã‚‹
                            
                            with col_text:
                                st.markdown(f"### {name}")
                                # åˆ†æãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º
                                st.markdown(section.replace("\n", "  \n"))
                            
                            with col_graph:
                                st.plotly_chart(fig, use_container_width=True)

                # CSVä¿å­˜å‡¦ç†ï¼ˆä¸­ç•¥ã›ãšæ›¸ããªã‚‰ä»¥ä¸‹ã®é€šã‚Šï¼‰
                df = pd.DataFrame([[
                    datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                    target_type, gender, kanji_count, use_kanji, avoid_kanji, wish, response_content
                ]], columns=["timestamp", "å¯¾è±¡", "æ€§åˆ¥", "æ¼¢å­—æ•°", "ä½¿ã„ãŸã„æ¼¢å­—", "é¿ã‘ãŸã„æ¼¢å­—", "é¡˜ã„", "ç”Ÿæˆå€™è£œ"])
                filename = f"names_api_{datetime.now().strftime('%Y%m%d')}.csv"
                df.to_csv(filename, index=False, mode="a", header=False, encoding="utf-8-sig")

            except Exception as e:
                st.error(f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

# ------------------------------
# è©•ä¾¡ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¸ã®ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤º
# ------------------------------
st.markdown("---")  # åŒºåˆ‡ã‚Šç·šã‚’è¡¨ç¤º
st.markdown("### è©•ä¾¡ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¯ã“ã¡ã‚‰")
st.markdown("[ğŸ‘‰ Googleãƒ•ã‚©ãƒ¼ãƒ ã§è©•ä¾¡ã™ã‚‹](https://www.amazon.co.jp/)")







































